<template>
  <SecreLayout>
    <div class="page-content">
      <!-- ‚úÖ ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ -->
      <h1
        class="text-4xl font-bold mb-6 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent"
      >
        Request Document
      </h1>

      <!-- ‚úÖ ‡∏õ‡πä‡∏≠‡∏ö‡∏≠‡∏±‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• -->
      <div
        v-if="showRejectModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      >
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
          <h3 class="text-xl font-bold text-gray-800 mb-4">
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
          </h3>

          <!-- üîπ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -->
          <div class="space-y-3 mb-6">
            <label
              class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"
            >
              <input
                type="radio"
                v-model="selectedReason"
                value="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡∏¥‡∏î"
                class="mr-3"
              />
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ú‡∏¥‡∏î
            </label>

            <label
              class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"
            >
              <input
                type="radio"
                v-model="selectedReason"
                value="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"
                class="mr-3"
              />
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            </label>

            <!-- ‚úÖ ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' -->
            <label
              class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50"
            >
              <input
                type="radio"
                v-model="selectedReason"
                value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
                class="mr-3"
              />
              ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏)
            </label>

            <!-- ‚úÖ ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' -->
            <textarea
              v-if="selectedReason === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'"
              v-model="customReason"
              rows="3"
              placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."
              class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-400 mt-2"
            ></textarea>
          </div>

          <div class="flex gap-3">
            <button
              @click="confirmReject"
              class="flex-1 px-4 py-2 bg-emerald-500 text-white rounded-lg hover:shadow-lg transition-all transform hover:-translate-y-0.5"
            >
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
            <button
              @click="cancelReject"
              class="flex-1 px-4 py-2 bg-rose-500 text-white rounded-lg hover:shadow-lg transition-all transform hover:-translate-y-0.5"
            >
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
          </div>
        </div>
      </div>

      <!-- ‚úÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
      <div
        class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200"
      >
        <table class="w-full">
          <thead class="bg-gradient-to-r from-indigo-50 to-violet-50">
            <tr>
              <th class="px-6 py-4 text-left text-sm font-bold text-indigo-800">
                No
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-indigo-800">
                ID
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-indigo-800">
                Name
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-indigo-800">
                Date
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-indigo-800">
                Topic
              </th>
              <th class="px-6 py-4 text-left text-sm font-bold text-indigo-800">
                File
              </th>
              <th class="px-6 py-4 text-right text-sm font-bold text-indigo-800">
                Status
              </th>
            </tr>
          </thead>

          <tbody class="divide-y divide-gray-100">
            <tr
              v-for="item in paginatedRequests"
              :key="item.no"
              class="hover:bg-gray-50 transition-colors"
            >
              <td class="px-6 py-4 text-sm font-medium text-gray-900">
                {{ item.no }}
              </td>
              <td class="px-6 py-4 text-sm text-gray-700">
                {{ item.studentId }}
              </td>
              <td class="px-6 py-4 text-sm text-gray-700">{{ item.name }}</td>
              <td class="px-6 py-4 text-sm text-gray-700">{{ item.date }}</td>
              <td class="px-6 py-4 text-sm text-gray-700">{{ item.topic }}</td>

              <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÑ‡∏ü‡∏•‡πå -->
              <td class="px-6 py-4 text-center">
                <img
                  v-if="isImage(item.image_path)"
                  :src="getImageUrl(item.image_path)"
                  alt="Document"
                  class="h-16 w-16 rounded-lg object-cover border mx-auto shadow-sm hover:scale-105 transition-transform"
                />
                <a
                  v-else-if="item.image_path"
                  :href="getImageUrl(item.image_path)"
                  target="_blank"
                  class="text-blue-600 underline"
                >
                  View File
                </a>
                <span v-else class="text-gray-400 italic">No file</span>
              </td>

              <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
              <td class="px-6 py-4 text-right">
                <!-- Pending -->
                <template v-if="item.status === 'Pending'">
                  <button
                    @click="approve(item)"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-xl bg-emerald-500 text-white hover:bg-emerald-600 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 mr-2"
                  >
                    ‚úÖ Approve
                  </button>
                  <button
                    @click="reject(item)"
                    class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-xl bg-rose-500 text-white hover:bg-rose-600 shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5"
                  >
                    ‚ùå Reject
                  </button>
                </template>

                <!-- Approved -->
                <span
                  v-else-if="item.status === 'Approved'"
                  class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-xl bg-emerald-100 text-emerald-800"
                >
                  ‚úÖ Approved
                </span>

                <!-- Rejected -->
                <span
                  v-else
                  class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-xl bg-rose-100 text-rose-800"
                >
                  ‚ùå Rejected
                </span>
              </td>
            </tr>

            <!-- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
            <tr v-if="requests.length === 0">
              <td
                colspan="7"
                class="text-center py-10 text-gray-500 text-sm bg-gray-50"
              >
                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ‚úÖ Pagination -->
      <div
        v-if="totalPages > 1"
        class="flex justify-center items-center mt-8 space-x-1"
      >
        <button
          v-for="page in totalPages"
          :key="page"
          @click="goToPage(page)"
          :class="[ 'px-3 py-1 rounded text-sm',
            page === currentPage
              ? 'bg-indigo-600 text-white font-bold'
              : 'bg-gray-200 hover:bg-gray-300 text-gray-700',
          ]"
        >
          {{ page }}
        </button>

        <button
          v-if="currentPage < totalPages"
          @click="goToPage(currentPage + 1)"
          class="ml-2 px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm"
        >
          ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        </button>
      </div>
    </div>
  </SecreLayout>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import SecreLayout from '@/layouts/secretary/SecreLayout.vue'

// ------------------------------------------
// üîπ STATE
// ------------------------------------------
const requests = ref([])
const showRejectModal = ref(false)
const selectedReason = ref('')
const customReason = ref('')
const currentRejectItem = ref(null)

const currentPage = ref(1)
const itemsPerPage = 7

// ------------------------------------------
// üîπ Pagination
// ------------------------------------------
const paginatedRequests = computed(() => {
  const start = (currentPage.value - 1) * itemsPerPage
  const end = start + itemsPerPage
  return requests.value.slice(start, end)
})
const totalPages = computed(() =>
  Math.ceil(requests.value.length / itemsPerPage)
)
const goToPage = (page) => {
  if (page >= 1 && page <= totalPages.value) {
    currentPage.value = page
    window.scrollTo({ top: 0, behavior: 'smooth' })
  }
}

// ------------------------------------------
// üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å backend
// ------------------------------------------
const formatDate = (iso) => {
  if (!iso) return '-'
  const d = new Date(iso)
  return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear() + 543}`
}

onMounted(async () => {
  const token = localStorage.getItem('authToken')
  if (!token) return
  try {
    const res = await fetch('/api/secretary/documentRequests', {
      headers: { Authorization: `Bearer ${token}` },
    })
    const data = await res.json()
    requests.value = (data.requests || []).map((item) => ({
      no: item.document_id,
      studentId: item.studentId,
      name: item.full_name,
      date: formatDate(item.submit_date),
      topic: item.topic,
      image_path: item.image_path || null, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û
      status:
        item.status === 1
          ? 'Approved'
          : item.status === 2
          ? 'Rejected'
          : 'Pending',
    }))
  } catch (err) {
    console.error('‚ùå Fetch error:', err)
  }
})

// ------------------------------------------
// üîπ Approve / Reject
// ------------------------------------------
const approve = async (item) => {
  const token = localStorage.getItem('authToken')
  try {
    await fetch('/api/secretary/updateDocumentStatus', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({ document_id: item.no, status: 1 }),
    })
    const i = requests.value.findIndex((r) => r.no === item.no)
    if (i !== -1) requests.value.splice(i, 1, { ...item, status: 'Approved' })
  } catch (err) {
    console.error('‚ùå Approve failed:', err)
  }
}

const reject = (item) => {
  currentRejectItem.value = item
  showRejectModal.value = true
}

const confirmReject = async () => {
  if (!selectedReason.value)
    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£')

  const finalReason =
    selectedReason.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
      ? customReason.value.trim()
      : selectedReason.value

  if (selectedReason.value === '‡∏≠‡∏∑‡πà‡∏ô‡πÜ' && !finalReason)
    return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°')

  const token = localStorage.getItem('authToken')
  try {
    await fetch('/api/secretary/updateDocumentStatus', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({
        document_id: currentRejectItem.value.no,
        status: 3, // ‚ùå ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Reject (3)
        reason: finalReason,
      }),
    })

    const idx = requests.value.findIndex(
      (r) => r.no === currentRejectItem.value.no
    )
    if (idx !== -1)
      requests.value.splice(idx, 1, {
        ...currentRejectItem.value,
        status: 'Rejected',
        rejectionReason: finalReason,
      })

    showRejectModal.value = false
    selectedReason.value = ''
    customReason.value = ''
  } catch (err) {
    console.error('‚ùå Reject failed:', err)
  }
}

// ------------------------------------------
// üîπ ‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
// ------------------------------------------
const isImage = (path) => {
  if (!path) return false
  return /\.(png|jpg|jpeg|gif)$/i.test(path)
}

const getImageUrl = (path) => {
  if (!path) return null
  const baseUrl = 'http://localhost:3000'

  // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á backslash (\) ‚Üí forward slash (/)
  let cleanPath = path.replace(/\\/g, '/')

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ 'uploads/documents/uploads/documents/' ‡∏ã‡πâ‡∏≥ ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  cleanPath = cleanPath.replace(/(uploads\/documents\/)+/, 'uploads/documents/')

  // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ '/' ‡∏ã‡πâ‡∏≥‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πá‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  const fullUrl = `${baseUrl}/${cleanPath.replace(/^\/+/, '')}`

  console.log('üñºÔ∏è Final image URL:', fullUrl)
  return fullUrl
}



// ‚úÖ ‡∏õ‡∏¥‡∏î modal
const cancelReject = () => {
  showRejectModal.value = false
  selectedReason.value = ''
  customReason.value = ''
}
</script>

<style scoped>
.page-content {
  padding: 2rem;
  min-height: 100vh;
  box-sizing: border-box;
}
</style>
